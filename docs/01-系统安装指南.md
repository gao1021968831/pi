# 树莓派4B系统安装配置指南

## 1. 系统安装

### 1.1 下载系统镜像
- 下载 Raspberry Pi OS Lite (64-bit) 
- 推荐使用 Raspberry Pi Imager 工具

### 1.2 烧录系统
```bash
# 使用 Raspberry Pi Imager 或 dd 命令
sudo dd if=raspios-lite-arm64.img of=/dev/sdX bs=4M status=progress
```

### 1.3 启用SSH（烧录后在boot分区）
```bash
# 在SD卡boot分区创建ssh文件
touch /boot/ssh
```

### 1.4 配置WiFi（可选）
在boot分区创建 `wpa_supplicant.conf`：
```
country=CN
ctrl_interface=DIR=/var/run/wpa_supplicant GROUP=netdev
update_config=1

network={
    ssid="你的WiFi名称"
    psk="你的WiFi密码"
}
```

## 2. 系统基础配置

### 2.1 首次启动配置
```bash
# SSH连接树莓派
ssh pi@树莓派IP

# 更新系统
sudo apt update && sudo apt upgrade -y

# 配置系统
sudo raspi-config
# 选择：
# - 1 System Options -> S4 Hostname (设置主机名)
# - 3 Interface Options -> P2 SSH (启用SSH)
# - 5 Localisation Options -> L4 WLAN Country (设置CN)
```

### 2.2 安装必要软件
```bash
# 安装基础软件
sudo apt install -y python3-pip python3-venv git vim htop

# 安装Flask相关
sudo apt install -y python3-flask python3-sqlite3

# 安装Samba
sudo apt install -y samba samba-common-bin

# 安装网络工具
sudo apt install -y hostapd dnsmasq
```

## 3. 热点自动连接配置

### 3.1 配置热点模式
创建热点配置脚本：
```bash
sudo nano /etc/systemd/system/hotspot.service
```

### 3.2 网络切换逻辑
- 优先连接已知WiFi网络
- 无可用WiFi时自动开启热点模式
- 检测到可用WiFi时自动切换回客户端模式

## 4. 开机自启动配置

### 4.1 创建系统服务
```bash
# Flask服务
sudo systemctl enable flask-server.service

# 云同步服务
sudo systemctl enable cloud-sync.timer

# Samba服务
sudo systemctl enable smbd nmbd
```

### 4.2 防火墙配置
```bash
# 开放必要端口
sudo ufw allow 22    # SSH
sudo ufw allow 80    # HTTP
sudo ufw allow 445   # Samba
sudo ufw allow 139   # Samba
sudo ufw enable
```

## 5. 系统优化

### 5.1 性能优化
```bash
# 增加swap空间
sudo dphys-swapfile swapoff
sudo nano /etc/dphys-swapfile
# 设置 CONF_SWAPSIZE=1024
sudo dphys-swapfile setup
sudo dphys-swapfile swapon
```

### 5.2 存储优化
```bash
# 配置日志轮转
sudo nano /etc/logrotate.d/rsyslog
# 限制日志文件大小和数量
```

## 6. 验证安装
```bash
# 检查服务状态
sudo systemctl status flask-server
sudo systemctl status smbd
sudo systemctl status hostapd

# 检查网络配置
ip addr show
iwconfig
```

## 下一步
完成系统安装后，继续阅读 `02-服务配置指南.md` 进行详细的服务配置。
