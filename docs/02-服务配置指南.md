# 服务配置指南

## 1. 一键安装脚本

### 1.1 创建主安装脚本
```bash
sudo nano /home/pi/shumeipai/scripts/setup.sh
```

```bash
#!/bin/bash
# 树莓派数据收集系统一键安装脚本

set -e

echo "=== 树莓派数据收集系统安装 ==="

# 检查权限
if [ "$EUID" -ne 0 ]; then
    echo "请使用sudo运行此脚本"
    exit 1
fi

# 更新系统
echo "1. 更新系统..."
apt update && apt upgrade -y

# 安装Python依赖
echo "2. 安装Python环境..."
apt install -y python3-pip python3-venv python3-flask python3-sqlite3
pip3 install flask qrcode[pil] requests

# 配置Flask服务
echo "3. 配置Flask服务..."
cp /home/pi/shumeipai/config/flask-server.service /etc/systemd/system/
systemctl daemon-reload
systemctl enable flask-server
systemctl start flask-server

# 配置Samba
echo "4. 配置Samba服务..."
/home/pi/shumeipai/scripts/setup_samba.sh

# 配置WiFi热点
echo "5. 配置WiFi热点..."
/home/pi/shumeipai/scripts/setup_hotspot.sh

# 配置云端同步
echo "6. 配置云端同步..."
cp /home/pi/shumeipai/config/cloud-sync.service /etc/systemd/system/
cp /home/pi/shumeipai/config/cloud-sync.timer /etc/systemd/system/
systemctl daemon-reload
systemctl enable cloud-sync.timer
systemctl start cloud-sync.timer

# 创建数据目录
echo "7. 创建数据目录..."
mkdir -p /home/pi/data/{submissions,uploads,logs,config,backups}
chown -R pi:pi /home/pi/data
chmod -R 755 /home/pi/data

echo "=== 安装完成 ==="
echo "Web界面: http://$(hostname -I | awk '{print $1}'):5000"
echo "管理面板: http://$(hostname -I | awk '{print $1}'):5000/admin"
```

### 1.2 设置执行权限
```bash
chmod +x /home/pi/shumeipai/scripts/*.sh
```

## 2. 系统服务配置

### 2.1 Flask服务配置
创建 `/etc/systemd/system/flask-server.service`：
```ini
[Unit]
Description=Flask Data Collection Server
After=network.target

[Service]
Type=simple
User=pi
WorkingDirectory=/home/pi/shumeipai/flask_server
ExecStart=/usr/bin/python3 app.py
Restart=always
RestartSec=10
Environment=PYTHONPATH=/home/pi/shumeipai/flask_server

[Install]
WantedBy=multi-user.target
```

### 2.2 云端同步服务配置
创建 `/etc/systemd/system/cloud-sync.service`：
```ini
[Unit]
Description=Cloud Data Sync Service
After=network.target

[Service]
Type=oneshot
User=pi
WorkingDirectory=/home/pi/shumeipai/scripts
ExecStart=/usr/bin/python3 cloud_sync.py
```

创建 `/etc/systemd/system/cloud-sync.timer`：
```ini
[Unit]
Description=Run cloud sync every 5 minutes
Requires=cloud-sync.service

[Timer]
OnCalendar=*:0/5
Persistent=true

[Install]
WantedBy=timers.target
```

### 2.3 WiFi热点服务配置
创建 `/etc/systemd/system/wifi-hotspot.service`：
```ini
[Unit]
Description=WiFi Hotspot Auto Switch Service
After=network.target

[Service]
Type=simple
User=root
ExecStart=/home/pi/shumeipai/scripts/wifi_hotspot.sh
Restart=always
RestartSec=30

[Install]
WantedBy=multi-user.target
```

## 3. 网络配置

### 3.1 hostapd配置
创建 `/etc/hostapd/hostapd.conf`：
```
interface=wlan0
driver=nl80211
ssid=RasPi-DataCollector
hw_mode=g
channel=7
wmm_enabled=0
macaddr_acl=0
auth_algs=1
ignore_broadcast_ssid=0
wpa=2
wpa_passphrase=raspberry2024
wpa_key_mgmt=WPA-PSK
wpa_pairwise=TKIP
rsn_pairwise=CCMP
```

### 3.2 dnsmasq配置
编辑 `/etc/dnsmasq.conf`：
```
interface=wlan0
dhcp-range=192.168.4.2,192.168.4.20,255.255.255.0,24h
```

## 4. 防火墙配置

```bash
# 启用UFW防火墙
sudo ufw enable

# 开放必要端口
sudo ufw allow 22    # SSH
sudo ufw allow 80    # HTTP
sudo ufw allow 5000  # Flask
sudo ufw allow 445   # Samba
sudo ufw allow 139   # Samba
sudo ufw allow 53    # DNS
sudo ufw allow 67    # DHCP
```

## 5. 服务管理命令

### 5.1 启动所有服务
```bash
sudo systemctl start flask-server
sudo systemctl start smbd nmbd
sudo systemctl start wifi-hotspot
sudo systemctl start cloud-sync.timer
```

### 5.2 检查服务状态
```bash
sudo systemctl status flask-server
sudo systemctl status smbd
sudo systemctl status wifi-hotspot
sudo systemctl status cloud-sync.timer
```

### 5.3 查看日志
```bash
# Flask服务日志
sudo journalctl -u flask-server -f

# WiFi热点日志
tail -f /home/pi/data/logs/wifi_hotspot.log

# 云端同步日志
tail -f /home/pi/data/logs/cloud_sync.log
```

## 6. 故障排除

### 6.1 常见问题
1. **Flask服务无法启动**
   - 检查Python依赖: `pip3 list | grep flask`
   - 检查端口占用: `netstat -tlnp | grep 5000`

2. **WiFi热点无法开启**
   - 检查hostapd配置: `sudo hostapd -d /etc/hostapd/hostapd.conf`
   - 检查网络接口: `iwconfig`

3. **Samba无法访问**
   - 检查服务状态: `sudo systemctl status smbd`
   - 测试配置: `testparm`

### 6.2 重置服务
```bash
# 重置所有服务
sudo systemctl daemon-reload
sudo systemctl restart flask-server
sudo systemctl restart smbd nmbd
sudo systemctl restart wifi-hotspot
```

## 7. 性能优化

### 7.1 系统优化
```bash
# 增加文件描述符限制
echo "* soft nofile 65536" >> /etc/security/limits.conf
echo "* hard nofile 65536" >> /etc/security/limits.conf

# 优化网络参数
echo "net.core.rmem_max = 16777216" >> /etc/sysctl.conf
echo "net.core.wmem_max = 16777216" >> /etc/sysctl.conf
```

### 7.2 数据库优化
```sql
-- SQLite优化设置
PRAGMA journal_mode = WAL;
PRAGMA synchronous = NORMAL;
PRAGMA cache_size = 10000;
PRAGMA temp_store = memory;
```
